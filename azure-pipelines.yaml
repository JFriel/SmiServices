
# SMI Services Build Pipeline Configuration

# TODO:
# - Pull & setup containers
# - Fix & enable the tests
# - "dotnet publish" after dotnet tests pass
# - "mvn assembly:single@create-deployable" after Java tests pass

trigger:
  batch: true
  branches:
    include:
    - master
    - develop

pr:
  autoCancel: true
  branches:
    include:
    - master
    - develop

stages:

- stage: Build
  displayName: Build all projects
  jobs:
  - job: BuildDotnet
    displayName: Build - .NET Core Projects
    strategy:
      matrix:
        Linux:
          imageName: 'ubuntu-latest'
        Windows:
          imageName: 'windows-latest'
    pool:
      name: 'Azure Pipelines'
      vmImage: $(imageName)
    steps:
      - task: DotNetCoreCLI@2
        inputs:
          command: 'build'
          projects: './SmiServices.sln'
  - job: BuildJava
    displayName: Build - Java Projects
    pool:
      name: 'Azure Pipelines'
      vmImage: 'ubuntu-latest'
    variables:
      parentPom: './src/common/com.smi.microservices.parent/pom.xml'
    steps:
    - bash: |
        bash ./installDat.sh
      displayName: Maven - Install CTP/DAT Dependencies
      workingDirectory: ./lib/java
    - bash: |
        mvn -f $(parentPom) test-compile dependency:resolve > /dev/null
      displayName: Maven - Resolve Dependencies
    - task: Maven@3
      displayName: Maven - Compile
      inputs:
        mavenPomFile: $(parentPom)
        options: '-DskipTests'
        publishJUnitResults: false
        javaHomeOption: 'JDKVersion'
        mavenVersionOption: 'Default'
        mavenAuthenticateFeed: false
        effectivePomSkip: false
        sonarQubeRunAnalysis: false
